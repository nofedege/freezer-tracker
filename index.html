<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>-80 Freezer Cell Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        
        input, select {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .export-btn {
            background-color: #2196F3;
        }
        
        .export-btn:hover {
            background-color: #1976D2;
        }
        
        .print-btn {
            background-color: #ff9800;
        }
        
        .print-btn:hover {
            background-color: #f57c00;
        }
        
        .clear-btn {
            background-color: #f44336;
        }
        
        .clear-btn:hover {
            background-color: #d32f2f;
        }
        
        .freezer-box {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            max-width: 800px;
            margin: 20px auto;
            background-color: #e0e0e0;
            padding: 10px;
            border-radius: 10px;
        }
        
        .cell {
            aspect-ratio: 1;
            border: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            text-align: center;
            padding: 2px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            border-radius: 3px;
        }
        
        .cell:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .cell.dragging {
            opacity: 0.5;
            transform: scale(1.1);
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .cell.drag-over {
            border: 3px dashed #4CAF50;
            background-color: #e8f5e8;
        }
        
        .cell.selected {
            border: 3px solid #ff9800 !important;
            background-color: #fff3e0 !important;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
        }
        
        .selection-mode .cell.occupied:hover {
            border: 3px dashed #ff9800;
            transform: scale(1.02);
        }
        
        .edit-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .label-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-content.wide {
            max-width: 700px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close-btn {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
            padding: 0;
        }
        
        .close-btn:hover {
            color: #000;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .save-btn {
            background-color: #4CAF50;
            color: white;
        }
        
        .save-btn:hover {
            background-color: #45a049;
        }
        
        .cancel-btn {
            background-color: #f44336;
            color: white;
        }
        
        .cancel-btn:hover {
            background-color: #d32f2f;
        }
        
        .delete-btn {
            background-color: #ff9800;
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #f57c00;
        }
        
        .cell.occupied {
            background-color: #ffebee;
            border-color: #e57373;
            position: relative;
        }
        
        .cell.jsl020 {
            background-color: #ffcdd2;
            border-color: #d32f2f;
            color: white;
            font-weight: bold;
        }
        
        .cell.ym447 {
            background-color: #c8e6c9;
            border-color: #4caf50;
            color: #1b5e20;
            font-weight: bold;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }
        
        .status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .box-info {
            text-align: center;
            margin: 15px 0;
            font-size: 14px;
            color: #666;
        }
        
        .sample-details {
            font-size: 9px;
            line-height: 1.1;
        }

        .label-settings {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .label-preview {
            border: 2px dashed #ccc;
            padding: 20px;
            margin: 15px 0;
            background-color: #fafafa;
            text-align: center;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .label-template {
            border: 1px solid #333;
            background: white;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 8px;
            line-height: 1.1;
            width: 180px;
            height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .pending-labels {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .pending-labels h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }

        .pending-list {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: 3px;
            padding: 10px;
        }

        .pending-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .pending-item:last-child {
            border-bottom: none;
        }

        .label-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>-80¬∞C Freezer Cell Tracker</h1>
        
        <div class="input-section">
            <div class="input-group">
                <label for="projectName">Project Name:</label>
                <input type="text" id="projectName" placeholder="e.g., JSL020+, YM447">
            </div>
            
            <div class="input-group">
                <label for="cellType">Cell Type:</label>
                <select id="cellType">
                    <option value="">Select type</option>
                    <option value="single cell">Single cell</option>
                    <option value="pool">Pool</option>
                    <option value="bulk sort">Bulk sort</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="cloneName">Clone Name (if applicable):</label>
                <input type="text" id="cloneName" placeholder="e.g., 1H9, 2E8, B11">
            </div>
            
            <div class="input-group">
                <label for="freezeDate">Freeze Date:</label>
                <input type="date" id="freezeDate">
            </div>
            
            <div class="input-group">
                <label for="numVials">Number of Vials:</label>
                <input type="number" id="numVials" min="1" max="20" value="1">
            </div>
        </div>
        
        <div class="checkbox-group" style="justify-content: center; margin-bottom: 15px;">
            <input type="checkbox" id="printAfterAdd" checked>
            <label for="printAfterAdd">Automatically queue new samples for printing</label>
        </div>
        
        <div style="text-align: center;">
            <button onclick="addSamples()">Add Samples to Freezer</button>
            <button class="print-btn" onclick="openLabelModal()">Print Labels</button>
            <button class="export-btn" onclick="exportData()">Export to CSV</button>
            <button class="export-btn" onclick="saveData()">Save Data File</button>
            <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="loadData()">
            <button class="export-btn" onclick="document.getElementById('fileInput').click()">Load Data File</button>
            <button class="clear-btn" onclick="clearAll()">Clear All</button>
        </div>
        
        <div id="selectionMode" style="text-align: center; margin: 15px 0; display: none;">
            <div style="background-color: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                <strong>Label Selection Mode</strong> - Click cells to select for printing
                <div style="margin-top: 10px;">
                    <span id="selectedCount">0</span> cells selected
                </div>
            </div>
            <button onclick="addSelectedToQueue()" style="background-color: #4CAF50;">Add Selected to Print Queue</button>
            <button onclick="exitSelectionMode()" style="background-color: #f44336;">Exit Selection Mode</button>
        </div>
        
        <div id="status"></div>
        
        <div class="box-info">
            <strong>Freezer Box Layout (100 positions: A1-J10)</strong><br>
            <span id="occupancy">0 / 100 positions occupied</span>
        </div>
        
        <div class="legend" id="legendContainer">
            <div class="legend-item">
                <div class="legend-color" style="background-color: white; border: 1px solid #ccc;"></div>
                <span>Empty</span>
            </div>
            <div class="legend-item">
                <span style="font-style: italic;">üí° Tips: Click cells to edit ‚Ä¢ Drag cells to move ‚Ä¢ Hover for controls</span>
            </div>
        </div>
        
        <div class="freezer-box" id="freezerBox">
            <!-- Grid will be generated by JavaScript -->
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Sample Details</h3>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            
            <div class="input-section">
                <div class="input-group">
                    <label for="editPosition">Position:</label>
                    <input type="text" id="editPosition" readonly style="background-color: #f0f0f0;">
                </div>
                
                <div class="input-group">
                    <label for="editProjectName">Project Name:</label>
                    <input type="text" id="editProjectName" placeholder="e.g., JSL020+, YM447">
                </div>
                
                <div class="input-group">
                    <label for="editCellType">Cell Type:</label>
                    <select id="editCellType">
                        <option value="">Select type</option>
                        <option value="single cell">Single cell</option>
                        <option value="pool">Pool</option>
                        <option value="bulk sort">Bulk sort</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="editCloneName">Clone Name (if applicable):</label>
                    <input type="text" id="editCloneName" placeholder="e.g., 1H9, 2E8, B11">
                </div>
                
                <div class="input-group">
                    <label for="editFreezeDate">Freeze Date:</label>
                    <input type="date" id="editFreezeDate">
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="delete-btn" onclick="deleteSample()">Delete Sample</button>
                <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                <button class="save-btn" onclick="saveEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Label Printing Modal -->
    <div id="labelModal" class="label-modal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h3>üè∑Ô∏è Print Tube Labels</h3>
                <button class="close-btn" onclick="closeLabelModal()">&times;</button>
            </div>
            
            <div class="two-column">
                <div>
                    <div class="label-settings">
                        <h4>Label Settings</h4>
                        
                        <div class="input-group">
                            <label for="labelTemplate">Label Template:</label>
                            <select id="labelTemplate" onchange="updateLabelPreview()">
                                <option value="standard">Standard Tube Label</option>
                                <option value="compact">Compact Label</option>
                                <option value="detailed">Detailed Label</option>
                                <option value="qr">QR Code Label</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label for="labelSize">Label Size:</label>
                            <select id="labelSize" onchange="updateLabelPreview()">
                                <option value="0.5x1.5">0.5" x 1.5" (Tube wrap)</option>
                                <option value="0.375x1.25">0.375" x 1.25" (Small tube)</option>
                                <option value="0.75x1.5">0.75" x 1.5" (Large tube)</option>
                            </select>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="includeQR" onchange="updateLabelPreview()">
                            <label for="includeQR">Include QR Code</label>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="includeDate" checked onchange="updateLabelPreview()">
                            <label for="includeDate">Include Freeze Date</label>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="includePosition" checked onchange="updateLabelPreview()">
                            <label for="includePosition">Include Position</label>
                        </div>
                    </div>
                    
                    <div class="label-preview">
                        <div id="labelPreviewContent">
                            <div class="label-template">
                                <div><strong>JSL020+</strong></div>
                                <div>Single cell - A1</div>
                                <div>1H9</div>
                                <div>2024-01-15</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="pending-labels">
                        <h4>Pending Labels (<span id="pendingCount">0</span>)</h4>
                        <div class="pending-list" id="pendingList">
                            <div style="text-align: center; color: #666; font-style: italic;">
                                No labels queued for printing
                            </div>
                        </div>
                        
                        <div class="label-actions">
                            <button onclick="addAllToQueue()">Add All Samples</button>
                            <button onclick="enterSelectionMode()">Select Specific Cells</button>
                            <button onclick="clearQueue()">Clear Queue</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="export-btn" onclick="exportNiceLabel()">Export NiceLabel File</button>
                <button class="export-btn" onclick="exportBMP51()">Export Brady BMP51</button>
                <button class="export-btn" onclick="exportZPL()">Export ZPL Commands</button>
                <button class="print-btn" onclick="printToBrady()">Print to Brady BBP12</button>
                <button class="cancel-btn" onclick="closeLabelModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize freezer box data
        let freezerData = {};
        let draggedElement = null;
        let draggedPosition = null;
        let projectColors = {}; // Store colors for each project
        let colorIndex = 0;
        let currentEditPosition = null; // Track which cell is being edited
        let labelQueue = []; // Queue of samples to print labels for
        let selectionMode = false; // Track if we're in cell selection mode
        let selectedCells = []; // Track selected cells for printing
        
        // Color palette for projects - nice lab-friendly colors
        const colorPalette = [
            { bg: '#ffcdd2', border: '#d32f2f', text: '#b71c1c' }, // Red
            { bg: '#c8e6c9', border: '#4caf50', text: '#1b5e20' }, // Green
            { bg: '#bbdefb', border: '#2196f3', text: '#0d47a1' }, // Blue
            { bg: '#f8bbd9', border: '#e91e63', text: '#880e4f' }, // Pink
            { bg: '#dcedc8', border: '#8bc34a', text: '#33691e' }, // Light Green
            { bg: '#ffecb3', border: '#ffc107', text: '#e65100' }, // Amber
            { bg: '#d1c4e9', border: '#9c27b0', text: '#4a148c' }, // Purple
            { bg: '#b2dfdb', border: '#009688', text: '#004d40' }, // Teal
            { bg: '#ffccbc', border: '#ff5722', text: '#bf360c' }, // Deep Orange
            { bg: '#f3e5f5', border: '#9c27b0', text: '#6a1b9a' }, // Light Purple
            { bg: '#e8f5e8', border: '#66bb6a', text: '#2e7d32' }, // Mint
            { bg: '#fff3e0', border: '#ff9800', text: '#e65100' }, // Orange
            { bg: '#e3f2fd', border: '#42a5f5', text: '#1565c0' }, // Light Blue
            { bg: '#fce4ec', border: '#ec407a', text: '#ad1457' }, // Rose
            { bg: '#f1f8e9', border: '#9ccc65', text: '#558b2f' }  // Lime
        ];
        
        // Get or assign color for a project
        function getProjectColor(projectName) {
            const normalizedName = projectName.toLowerCase().trim();
            
            if (!projectColors[normalizedName]) {
                // Assign next color from palette
                const colorInfo = colorPalette[colorIndex % colorPalette.length];
                projectColors[normalizedName] = {
                    ...colorInfo,
                    originalName: projectName
                };
                colorIndex++;
                
                // Update legend
                updateLegend();
            }
            
            return projectColors[normalizedName];
        }
        
        // Update the legend to show all current projects
        function updateLegend() {
            const legendContainer = document.querySelector('.legend');
            
            // Clear existing legend items except the empty cell item and tip
            const staticItems = `
                <div class="legend-item">
                    <div class="legend-color" style="background-color: white; border: 1px solid #ccc;"></div>
                    <span>Empty</span>
                </div>
            `;
            
            const tipItem = `
                <div class="legend-item">
                    <span style="font-style: italic;">üí° Tip: Drag occupied cells to move samples around</span>
                </div>
            `;
            
            // Generate legend items for all projects
            let projectItems = '';
            Object.values(projectColors).forEach(colorInfo => {
                projectItems += `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${colorInfo.bg}; border: 1px solid ${colorInfo.border};"></div>
                        <span>${colorInfo.originalName}</span>
                    </div>
                `;
            });
            
            legendContainer.innerHTML = staticItems + projectItems + tipItem;
        }
        
        function initializeFreezerBox() {
            const freezerBox = document.getElementById('freezerBox');
            const rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
            
            for (let row = 0; row < 10; row++) {
                for (let col = 1; col <= 10; col++) {
                    const position = rows[row] + col;
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.id = position;
                    cell.onclick = () => showCellInfo(position);
                    
                    // Add drag and drop event listeners
                    cell.addEventListener('dragstart', handleDragStart);
                    cell.addEventListener('dragover', handleDragOver);
                    cell.addEventListener('drop', handleDrop);
                    cell.addEventListener('dragend', handleDragEnd);
                    cell.addEventListener('dragenter', handleDragEnter);
                    cell.addEventListener('dragleave', handleDragLeave);
                    
                    const positionLabel = document.createElement('div');
                    positionLabel.textContent = position;
                    positionLabel.style.fontSize = '8px';
                    positionLabel.style.fontWeight = 'bold';
                    
                    // Add drag handle for occupied cells
                    const dragHandle = document.createElement('div');
                    dragHandle.className = 'drag-handle';
                    
                    cell.appendChild(positionLabel);
                    cell.appendChild(dragHandle);
                    freezerBox.appendChild(cell);
                }
            }
            updateOccupancy();
        }
        
        // Drag and drop handlers
        function handleDragStart(e) {
            const position = e.target.id || e.target.closest('.cell').id;
            
            // Only allow dragging if cell is occupied
            if (!freezerData[position]) {
                e.preventDefault();
                return;
            }
            
            draggedElement = e.target.closest('.cell');
            draggedPosition = position;
            
            draggedElement.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedElement.outerHTML);
            
            showStatus(`Dragging sample from ${position}`, 'success');
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        function handleDragEnter(e) {
            const cell = e.target.closest('.cell');
            if (cell && cell !== draggedElement) {
                cell.classList.add('drag-over');
            }
        }
        
        function handleDragLeave(e) {
            const cell = e.target.closest('.cell');
            if (cell) {
                cell.classList.remove('drag-over');
            }
        }
        
        function handleDrop(e) {
            e.preventDefault();
            
            const targetCell = e.target.closest('.cell');
            const targetPosition = targetCell.id;
            
            // Remove drag-over styling
            targetCell.classList.remove('drag-over');
            
            if (!draggedPosition || targetPosition === draggedPosition) {
                return;
            }
            
            // Check if target position is occupied
            if (freezerData[targetPosition]) {
                // Swap samples
                const tempData = freezerData[draggedPosition];
                freezerData[draggedPosition] = freezerData[targetPosition];
                freezerData[targetPosition] = tempData;
                
                showStatus(`Swapped samples: ${draggedPosition} ‚Üî ${targetPosition}`, 'success');
            } else {
                // Move sample to empty position
                freezerData[targetPosition] = freezerData[draggedPosition];
                delete freezerData[draggedPosition];
                
                showStatus(`Moved sample: ${draggedPosition} ‚Üí ${targetPosition}`, 'success');
            }
            
            // Update displays
            updateCellDisplay(draggedPosition);
            updateCellDisplay(targetPosition);
        }
        
        function handleDragEnd(e) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }
            
            // Remove drag-over from all cells
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('drag-over');
            });
            
            draggedElement = null;
            draggedPosition = null;
        }
        
        // Find next available positions
        function findNextAvailablePositions(count) {
            const rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
            const positions = [];
            
            for (let row = 0; row < 10; row++) {
                for (let col = 1; col <= 10; col++) {
                    const position = rows[row] + col;
                    if (!freezerData[position]) {
                        positions.push(position);
                        if (positions.length === count) {
                            return positions;
                        }
                    }
                }
            }
            return positions;
        }
        
        // Add samples to freezer
        function addSamples() {
            const projectName = document.getElementById('projectName').value.trim();
            const cellType = document.getElementById('cellType').value;
            const cloneName = document.getElementById('cloneName').value.trim();
            const freezeDate = document.getElementById('freezeDate').value;
            const numVials = parseInt(document.getElementById('numVials').value);
            
            // Validation
            if (!projectName) {
                showStatus('Please enter a project name', 'error');
                return;
            }
            if (!cellType) {
                showStatus('Please select a cell type', 'error');
                return;
            }
            if (!freezeDate) {
                showStatus('Please enter a freeze date', 'error');
                return;
            }
            if (!numVials || numVials < 1) {
                showStatus('Please enter a valid number of vials', 'error');
                return;
            }
            
            // Find available positions
            const availablePositions = findNextAvailablePositions(numVials);
            if (availablePositions.length < numVials) {
                showStatus(`Only ${availablePositions.length} positions available, but ${numVials} requested`, 'error');
                return;
            }
            
            // Create sample data
            const sampleInfo = {
                project: projectName,
                type: cellType,
                clone: cloneName,
                date: freezeDate,
                dateAdded: new Date().toISOString().split('T')[0]
            };
            
            // Add to freezer data and update display
            const addedPositions = [];
            availablePositions.forEach(position => {
                freezerData[position] = { ...sampleInfo };
                updateCellDisplay(position);
                addedPositions.push(position);
            });
            
            // Automatically add new samples to label queue if option is checked
            const shouldPrintAfterAdd = document.getElementById('printAfterAdd').checked;
            if (shouldPrintAfterAdd) {
                addedPositions.forEach(position => {
                    addToLabelQueue(position);
                });
                showStatus(`Successfully added ${numVials} vials to positions: ${availablePositions.join(', ')}. Added to label queue.`, 'success');
            } else {
                showStatus(`Successfully added ${numVials} vials to positions: ${availablePositions.join(', ')}.`, 'success');
            }
            updateOccupancy();
            
            // Clear form
            document.getElementById('projectName').value = '';
            document.getElementById('cellType').value = '';
            document.getElementById('cloneName').value = '';
            document.getElementById('freezeDate').value = '';
            document.getElementById('numVials').value = '1';
        }
        
        // Update cell display
        function updateCellDisplay(position) {
            const cell = document.getElementById(position);
            const data = freezerData[position];
            
            if (data) {
                cell.className = 'cell occupied';
                cell.draggable = true;
                
                // Get project-specific color
                const colorInfo = getProjectColor(data.project);
                
                // Apply custom styling
                cell.style.backgroundColor = colorInfo.bg;
                cell.style.borderColor = colorInfo.border;
                cell.style.color = colorInfo.text;
                cell.style.fontWeight = 'bold';
                
                // Clear existing content
                cell.innerHTML = '';
                
                const positionLabel = document.createElement('div');
                positionLabel.textContent = position;
                positionLabel.style.fontSize = '8px';
                positionLabel.style.fontWeight = 'bold';
                positionLabel.style.color = colorInfo.text;
                
                const sampleInfo = document.createElement('div');
                sampleInfo.className = 'sample-details';
                sampleInfo.style.color = colorInfo.text;
                sampleInfo.innerHTML = `
                    <div>${data.project}</div>
                    <div>${data.type}</div>
                    ${data.clone ? `<div>${data.clone}</div>` : ''}
                    <div>${data.date}</div>
                `;
                
                const dragHandle = document.createElement('div');
                dragHandle.className = 'drag-handle';
                dragHandle.title = 'Drag to move sample';
                dragHandle.style.backgroundColor = colorInfo.text;
                
                const editIcon = document.createElement('div');
                editIcon.className = 'edit-icon';
                editIcon.title = 'Click to edit sample';
                editIcon.innerHTML = '‚úé';
                editIcon.style.color = 'white';
                editIcon.style.backgroundColor = colorInfo.text;
                editIcon.onclick = function(e) {
                    e.stopPropagation();
                    openEditModal(position);
                };
                
                cell.appendChild(positionLabel);
                cell.appendChild(sampleInfo);
                cell.appendChild(dragHandle);
                cell.appendChild(editIcon);
            } else {
                cell.className = 'cell';
                cell.draggable = false;
                cell.style.backgroundColor = 'white';
                cell.style.borderColor = '#ccc';
                cell.style.color = '#333';
                cell.style.fontWeight = 'normal';
                cell.innerHTML = `<div style="font-size: 8px; font-weight: bold;">${position}</div>`;
            }
        }
        
        // Show cell information or edit
        function showCellInfo(position) {
            const data = freezerData[position];
            
            if (selectionMode && data) {
                // In selection mode, toggle cell selection
                toggleCellSelection(position);
            } else if (data) {
                // Normal mode, open edit modal
                openEditModal(position);
            }
        }
        
        // Toggle cell selection for printing
        function toggleCellSelection(position) {
            const cell = document.getElementById(position);
            const index = selectedCells.indexOf(position);
            
            if (index > -1) {
                // Deselect
                selectedCells.splice(index, 1);
                cell.classList.remove('selected');
            } else {
                // Select
                selectedCells.push(position);
                cell.classList.add('selected');
            }
            
            updateSelectedCount();
        }
        
        // Update selected cell count display
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedCells.length;
        }
        
        // Enter selection mode
        function enterSelectionMode() {
            selectionMode = true;
            selectedCells = [];
            document.getElementById('selectionMode').style.display = 'block';
            document.getElementById('freezerBox').classList.add('selection-mode');
            closeLabelModal();
            showStatus('Selection mode active - click cells to select for printing', 'success');
        }
        
        // Exit selection mode
        function exitSelectionMode() {
            selectionMode = false;
            selectedCells.forEach(position => {
                document.getElementById(position).classList.remove('selected');
            });
            selectedCells = [];
            document.getElementById('selectionMode').style.display = 'none';
            document.getElementById('freezerBox').classList.remove('selection-mode');
            showStatus('Exited selection mode', 'success');
        }
        
        // Open edit modal
        function openEditModal(position) {
            const data = freezerData[position];
            if (!data) return;
            
            currentEditPosition = position;
            
            // Populate form fields
            document.getElementById('editPosition').value = position;
            document.getElementById('editProjectName').value = data.project;
            document.getElementById('editCellType').value = data.type;
            document.getElementById('editCloneName').value = data.clone || '';
            document.getElementById('editFreezeDate').value = data.date;
            
            // Show modal
            document.getElementById('editModal').style.display = 'block';
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditPosition = null;
        }
        
        // Save edited sample
        function saveEdit() {
            if (!currentEditPosition) return;
            
            const projectName = document.getElementById('editProjectName').value.trim();
            const cellType = document.getElementById('editCellType').value;
            const cloneName = document.getElementById('editCloneName').value.trim();
            const freezeDate = document.getElementById('editFreezeDate').value;
            
            // Validation
            if (!projectName) {
                showStatus('Please enter a project name', 'error');
                return;
            }
            if (!cellType) {
                showStatus('Please select a cell type', 'error');
                return;
            }
            if (!freezeDate) {
                showStatus('Please enter a freeze date', 'error');
                return;
            }
            
            // Update the sample data
            const oldProject = freezerData[currentEditPosition].project;
            freezerData[currentEditPosition] = {
                project: projectName,
                type: cellType,
                clone: cloneName,
                date: freezeDate,
                dateAdded: freezerData[currentEditPosition].dateAdded // Keep original add date
            };
            
            // Update cell display
            updateCellDisplay(currentEditPosition);
            
            // Update legend if project name changed
            if (oldProject.toLowerCase() !== projectName.toLowerCase()) {
                updateLegend();
            }
            
            closeEditModal();
            showStatus(`Updated sample at position ${currentEditPosition}`, 'success');
        }
        
        // Delete sample from edit modal
        function deleteSample() {
            if (!currentEditPosition) return;
            
            if (confirm(`Are you sure you want to delete the sample at position ${currentEditPosition}?`)) {
                delete freezerData[currentEditPosition];
                updateCellDisplay(currentEditPosition);
                updateOccupancy();
                closeEditModal();
                showStatus(`Deleted sample from position ${currentEditPosition}`, 'success');
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const labelModal = document.getElementById('labelModal');
            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === labelModal) {
                closeLabelModal();
            }
        }
        
        // Update occupancy display
        function updateOccupancy() {
            const occupied = Object.keys(freezerData).length;
            document.getElementById('occupancy').textContent = `${occupied} / 100 positions occupied`;
        }
        
        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 5000);
        }
        
        // Convert position to sequential number (A1=1, A2=2, ..., J10=100)
        function positionToNumber(position) {
            const rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
            const rowLetter = position[0];
            const col = parseInt(position.slice(1));
            const rowIndex = rows.indexOf(rowLetter);
            return (rowIndex * 10) + col;
        }
        
        // Export to CSV
        function exportData() {
            if (Object.keys(freezerData).length === 0) {
                showStatus('No data to export', 'error');
                return;
            }
            
            let csvContent = 'Position,Box Number,Project,Cell Type,Clone,Freeze Date,Date Added\n';
            
            // Sort positions by box number instead of alphabetically
            const positions = Object.keys(freezerData).sort((a, b) => {
                return positionToNumber(a) - positionToNumber(b);
            });
            
            positions.forEach(position => {
                const data = freezerData[position];
                const boxNumber = positionToNumber(position);
                
                // Wrap clone in quotes and escape any internal quotes
                // This prevents Excel from converting "2E8" to scientific notation
                const cloneText = data.clone ? `"${data.clone.replace(/"/g, '""')}"` : '""';
                
                csvContent += `${position},${boxNumber},"${data.project}","${data.type}",${cloneText},"${data.date}","${data.dateAdded}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `freezer_inventory_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('Data exported to CSV successfully', 'success');
        }
        
        // Save data to JSON file
        function saveData() {
            const dataToSave = {
                freezerData: freezerData,
                lastUpdated: new Date().toISOString(),
                version: "1.1"
            };
            
            const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `freezer_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('Data file saved successfully', 'success');
        }
        
        // Load data from JSON file
        function loadData() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    
                    if (loadedData.freezerData) {
                        // Confirm before overwriting existing data
                        if (Object.keys(freezerData).length > 0) {
                            if (!confirm('Loading this file will replace all current data. Continue?')) {
                                return;
                            }
                        }
                        
                        freezerData = loadedData.freezerData;
                        
                        // Update all cell displays
                        Object.keys(freezerData).forEach(position => {
                            updateCellDisplay(position);
                        });
                        
                        // Clear cells that are no longer occupied
                        const rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
                        for (let row = 0; row < 10; row++) {
                            for (let col = 1; col <= 10; col++) {
                                const position = rows[row] + col;
                                if (!freezerData[position]) {
                                    updateCellDisplay(position);
                                }
                            }
                        }
                        
                        updateOccupancy();
                        showStatus(`Data loaded successfully from ${file.name}`, 'success');
                    }
                } catch (error) {
                    showStatus('Error loading file: Invalid format', 'error');
                }
            };
            reader.readAsText(file);
            
            // Clear the file input
            fileInput.value = '';
        }
        
        // Clear all data
        function clearAll() {
            if (confirm('Are you sure you want to clear all freezer data? This cannot be undone.')) {
                freezerData = {};
                projectColors = {};
                colorIndex = 0;
                labelQueue = [];
                initializeFreezerBox();
                updateLegend();
                showStatus('All data cleared', 'success');
            }
        }

        // === LABEL PRINTING FUNCTIONS ===
        
        // Open label printing modal
        function openLabelModal() {
            document.getElementById('labelModal').style.display = 'block';
            updatePendingList();
            updateLabelPreview();
        }
        
        // Close label printing modal
        function closeLabelModal() {
            document.getElementById('labelModal').style.display = 'none';
        }
        
        // Add sample to label queue
        function addToLabelQueue(position) {
            if (!labelQueue.includes(position) && freezerData[position]) {
                labelQueue.push(position);
                updatePendingList();
            }
        }
        
        // Remove sample from label queue
        function removeFromLabelQueue(position) {
            const index = labelQueue.indexOf(position);
            if (index > -1) {
                labelQueue.splice(index, 1);
                updatePendingList();
            }
        }
        
        // Add all samples to queue
        function addAllToQueue() {
            labelQueue = Object.keys(freezerData);
            updatePendingList();
            showStatus(`Added ${labelQueue.length} samples to label queue`, 'success');
        }
        
        // Add selected samples to queue
        function addSelectedToQueue() {
            if (selectedCells.length === 0) {
                showStatus('No cells selected', 'error');
                return;
            }
            
            selectedCells.forEach(position => {
                addToLabelQueue(position);
            });
            
            showStatus(`Added ${selectedCells.length} selected samples to label queue`, 'success');
            exitSelectionMode();
            openLabelModal();
        }
        
        // Clear label queue
        function clearQueue() {
            labelQueue = [];
            updatePendingList();
            showStatus('Label queue cleared', 'success');
        }
        
        // Update pending labels list
        function updatePendingList() {
            const pendingList = document.getElementById('pendingList');
            const pendingCount = document.getElementById('pendingCount');
            
            pendingCount.textContent = labelQueue.length;
            
            if (labelQueue.length === 0) {
                pendingList.innerHTML = `
                    <div style="text-align: center; color: #666; font-style: italic;">
                        No labels queued for printing
                    </div>
                `;
                return;
            }
            
            let listHTML = '';
            labelQueue.forEach(position => {
                const data = freezerData[position];
                if (data) {
                    listHTML += `
                        <div class="pending-item">
                            <div>
                                <strong>${position}</strong> - ${data.project}
                                ${data.clone ? ` (${data.clone})` : ''}
                            </div>
                            <button style="background: #f44336; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer;" 
                                    onclick="removeFromLabelQueue('${position}')">√ó</button>
                        </div>
                    `;
                }
            });
            
            pendingList.innerHTML = listHTML;
        }
        
        // Update label preview
        function updateLabelPreview() {
            const template = document.getElementById('labelTemplate').value;
            const includeQR = document.getElementById('includeQR').checked;
            const includeDate = document.getElementById('includeDate').checked;
            const includePosition = document.getElementById('includePosition').checked;
            
            // Sample data for preview
            const sampleData = {
                project: 'JSL020+',
                type: 'Single cell',
                clone: '1H9',
                date: '2024-01-15',
                position: 'A1'
            };
            
            const previewContent = generateLabelHTML(sampleData, template, includeQR, includeDate, includePosition);
            document.getElementById('labelPreviewContent').innerHTML = previewContent;
        }
        
        // Generate label HTML based on template
        function generateLabelHTML(data, template, includeQR, includeDate, includePosition) {
            let labelContent = '';
            
            switch (template) {
                case 'compact':
                    labelContent = `
                        <div class="label-template" style="height: 40px;">
                            <div><strong>${data.project}</strong></div>
                            <div>${data.clone || data.type}</div>
                            ${includePosition ? `<div>${data.position}</div>` : ''}
                        </div>
                    `;
                    break;
                    
                case 'detailed':
                    labelContent = `
                        <div class="label-template" style="height: 80px;">
                            <div><strong>${data.project}</strong></div>
                            <div>${data.type}</div>
                            ${data.clone ? `<div>Clone: ${data.clone}</div>` : ''}
                            ${includePosition ? `<div>Pos: ${data.position}</div>` : ''}
                            ${includeDate ? `<div>${data.date}</div>` : ''}
                        </div>
                    `;
                    break;
                    
                case 'qr':
                    labelContent = `
                        <div class="label-template" style="height: 60px; display: flex;">
                            <div style="flex: 1;">
                                <div><strong>${data.project}</strong></div>
                                <div>${data.clone || data.type}</div>
                                ${includePosition ? `<div>${data.position}</div>` : ''}
                            </div>
                            <div style="width: 30px; height: 30px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 6px;">
                                QR
                            </div>
                        </div>
                    `;
                    break;
                    
                default: // standard
                    labelContent = `
                        <div class="label-template">
                            <div><strong>${data.project}</strong></div>
                            <div>${data.type}${includePosition ? ` - ${data.position}` : ''}</div>
                            ${data.clone ? `<div>${data.clone}</div>` : ''}
                            ${includeDate ? `<div>${data.date}</div>` : ''}
                        </div>
                    `;
            }
            
            return labelContent;
        }
        
        // Export NiceLabel file format
        function exportNiceLabel() {
            if (labelQueue.length === 0) {
                showStatus('No labels in queue to export', 'error');
                return;
            }
            
            const template = document.getElementById('labelTemplate').value;
            const labelSize = document.getElementById('labelSize').value;
            const includeQR = document.getElementById('includeQR').checked;
            const includeDate = document.getElementById('includeDate').checked;
            const includePosition = document.getElementById('includePosition').checked;
            
            // Generate NiceLabel-compatible CSV data file
            let csvContent = 'Position,Project,CellType,Clone,FreezeDate,QRData\n';
            
            labelQueue.forEach(position => {
                const data = freezerData[position];
                if (data) {
                    const qrData = `${data.project}|${position}|${data.date}`;
                    csvContent += `"${position}","${data.project}","${data.type}","${data.clone || ''}","${data.date}","${qrData}"\n`;
                }
            });
            
            // Create NiceLabel instructions file
            const niceLabelInstructions = `
NiceLabel Print Job Instructions
================================

Label Template Settings:
- Template: ${template}
- Size: ${labelSize}
- Include QR Code: ${includeQR ? 'Yes' : 'No'}
- Include Date: ${includeDate ? 'Yes' : 'No'}
- Include Position: ${includePosition ? 'Yes' : 'No'}

Total Labels: ${labelQueue.length}

Instructions:
1. Import the accompanying CSV file into NiceLabel
2. Configure your Brady BBP12 printer
3. Use the following field mappings:
   - Text1: Project
   - Text2: CellType
   - Text3: Clone
   - Text4: FreezeDate
   - Text5: Position
   - QRCode: QRData

Generated: ${new Date().toLocaleString()}
            `;
            
            // Download CSV data file
            const csvBlob = new Blob([csvContent], { type: 'text/csv' });
            const csvUrl = window.URL.createObjectURL(csvBlob);
            const csvLink = document.createElement('a');
            csvLink.href = csvUrl;
            csvLink.download = `label_data_${new Date().toISOString().split('T')[0]}.csv`;
            csvLink.click();
            window.URL.revokeObjectURL(csvUrl);
            
            // Download instructions file
            const instructionsBlob = new Blob([niceLabelInstructions], { type: 'text/plain' });
            const instructionsUrl = window.URL.createObjectURL(instructionsBlob);
            const instructionsLink = document.createElement('a');
            instructionsLink.href = instructionsUrl;
            instructionsLink.download = `nicelabel_instructions_${new Date().toISOString().split('T')[0]}.txt`;
            instructionsLink.click();
            window.URL.revokeObjectURL(instructionsUrl);
            
            showStatus(`Exported ${labelQueue.length} labels for NiceLabel`, 'success');
        }
        
        // Export for Brady BMP51 (LabelMark/Markware format)
        function exportBMP51() {
            if (labelQueue.length === 0) {
                showStatus('No labels in queue to export', 'error');
                return;
            }
            
            const template = document.getElementById('labelTemplate').value;
            const labelSize = document.getElementById('labelSize').value;
            const includeQR = document.getElementById('includeQR').checked;
            const includeDate = document.getElementById('includeDate').checked;
            const includePosition = document.getElementById('includePosition').checked;
            
            // Generate CSV data for BMP51 import
            let csvContent = 'LABEL_ID,PROJECT,CELL_TYPE,CLONE,POSITION,FREEZE_DATE,QR_DATA\n';
            
            labelQueue.forEach((position, index) => {
                const data = freezerData[position];
                if (data) {
                    const labelId = `TUBE_${String(index + 1).padStart(3, '0')}`;
                    const qrData = includeQR ? `${data.project}|${position}|${data.date}` : '';
                    
                    csvContent += `"${labelId}","${data.project}","${data.type}","${data.clone || ''}","${position}","${data.date}","${qrData}"\n`;
                }
            });
            
            // Generate BMP51 template instructions
            const bmp51Instructions = `
Brady BMP51 Label Template Instructions
======================================

Compatible with LabelMark and MarkWare software

STEP 1: Import Data
- Open Brady LabelMark or MarkWare software
- Import the accompanying CSV file: File > Import > CSV Data
- Map fields as follows:

STEP 2: Field Mapping
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ CSV Column      ‚îÇ Label Field      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ PROJECT         ‚îÇ Text Field 1     ‚îÇ
‚îÇ CELL_TYPE       ‚îÇ Text Field 2     ‚îÇ
‚îÇ CLONE           ‚îÇ Text Field 3     ‚îÇ
‚îÇ POSITION        ‚îÇ Text Field 4     ‚îÇ
‚îÇ FREEZE_DATE     ‚îÇ Text Field 5     ‚îÇ
‚îÇ QR_DATA         ‚îÇ Barcode Field    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

STEP 3: Label Layout Settings
- Label Size: ${labelSize}
- Template: ${template}
- Include QR Code: ${includeQR ? 'Yes' : 'No'}
- Include Date: ${includeDate ? 'Yes' : 'No'}
- Include Position: ${includePosition ? 'Yes' : 'No'}

STEP 4: Recommended Label Layout
${generateBMP51Layout(template, includeQR, includeDate, includePosition)}

STEP 5: Print Settings
- Printer: Brady BMP51
- Label Material: Select appropriate tube label stock
- Print Quality: High
- Copies: 1 per record

Total Labels to Print: ${labelQueue.length}
Generated: ${new Date().toLocaleString()}

TROUBLESHOOTING:
- Ensure BMP51 is connected and recognized
- Use genuine Brady label cartridges
- Check label alignment before bulk printing
- Test print 1-2 labels first

For technical support, refer to Brady BMP51 user manual
            `;
            
            // Generate MW file content (simplified Markware format)
            const mwContent = generateMarkwareFile(labelQueue, template, includeQR, includeDate, includePosition);
            
            // Download CSV data file
            const csvBlob = new Blob([csvContent], { type: 'text/csv' });
            const csvUrl = window.URL.createObjectURL(csvBlob);
            const csvLink = document.createElement('a');
            csvLink.href = csvUrl;
            csvLink.download = `bmp51_data_${new Date().toISOString().split('T')[0]}.csv`;
            csvLink.click();
            window.URL.revokeObjectURL(csvUrl);
            
            // Download instructions
            const instructionsBlob = new Blob([bmp51Instructions], { type: 'text/plain' });
            const instructionsUrl = window.URL.createObjectURL(instructionsBlob);
            const instructionsLink = document.createElement('a');
            instructionsLink.href = instructionsUrl;
            instructionsLink.download = `bmp51_instructions_${new Date().toISOString().split('T')[0]}.txt`;
            instructionsLink.click();
            window.URL.revokeObjectURL(instructionsUrl);
            
            // Download MW file
            const mwBlob = new Blob([mwContent], { type: 'application/octet-stream' });
            const mwUrl = window.URL.createObjectURL(mwBlob);
            const mwLink = document.createElement('a');
            mwLink.href = mwUrl;
            mwLink.download = `tube_labels_${new Date().toISOString().split('T')[0]}.mw`;
            mwLink.click();
            window.URL.revokeObjectURL(mwUrl);
            
            showStatus(`Exported ${labelQueue.length} labels for Brady BMP51`, 'success');
        }
        
        // Generate BMP51 layout description
        function generateBMP51Layout(template, includeQR, includeDate, includePosition) {
            let layout = '';
            
            switch (template) {
                case 'compact':
                    layout = `
Text Layout (Compact):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [PROJECT] (Large, Bold) ‚îÇ
‚îÇ [CLONE/CELL_TYPE]       ‚îÇ
‚îÇ [POSITION] (if enabled) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò`;
                    break;
                    
                case 'detailed':
                    layout = `
Text Layout (Detailed):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [PROJECT] (Large, Bold) ‚îÇ
‚îÇ Type: [CELL_TYPE]       ‚îÇ
‚îÇ Clone: [CLONE]          ‚îÇ
‚îÇ Pos: [POSITION]         ‚îÇ
‚îÇ [FREEZE_DATE]           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò`;
                    break;
                    
                case 'qr':
                    layout = `
Text + QR Layout:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [PROJECT] (Bold)‚îÇ QR  ‚îÇ
‚îÇ [CLONE/TYPE]    ‚îÇCode ‚îÇ
‚îÇ [POSITION]      ‚îÇ     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò`;
                    break;
                    
                default: // standard
                    layout = `
Text Layout (Standard):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [PROJECT] (Large, Bold) ‚îÇ
‚îÇ [CELL_TYPE] - [POS]     ‚îÇ
‚îÇ [CLONE] (if present)    ‚îÇ
‚îÇ [FREEZE_DATE]           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò`;
            }
            
            if (includeQR && template !== 'qr') {
                layout += `\n\nQR Code: Position in bottom-right corner\nQR Data Format: PROJECT|POSITION|DATE`;
            }
            
            return layout;
        }
        
        // Generate simplified Markware file content
        function generateMarkwareFile(queue, template, includeQR, includeDate, includePosition) {
            let mwContent = `[MARKWARE_FILE]\n`;
            mwContent += `VERSION=2.0\n`;
            mwContent += `LABEL_COUNT=${queue.length}\n`;
            mwContent += `TEMPLATE=${template}\n`;
            mwContent += `CREATED=${new Date().toISOString()}\n\n`;
            
            mwContent += `[LABEL_SETTINGS]\n`;
            mwContent += `SIZE=${document.getElementById('labelSize').value}\n`;
            mwContent += `INCLUDE_QR=${includeQR}\n`;
            mwContent += `INCLUDE_DATE=${includeDate}\n`;
            mwContent += `INCLUDE_POSITION=${includePosition}\n\n`;
            
            mwContent += `[DATA]\n`;
            queue.forEach((position, index) => {
                const data = freezerData[position];
                if (data) {
                    mwContent += `LABEL_${index + 1}:\n`;
                    mwContent += `  PROJECT=${data.project}\n`;
                    mwContent += `  CELL_TYPE=${data.type}\n`;
                    mwContent += `  CLONE=${data.clone || ''}\n`;
                    mwContent += `  POSITION=${position}\n`;
                    mwContent += `  FREEZE_DATE=${data.date}\n`;
                    if (includeQR) {
                        mwContent += `  QR_DATA=${data.project}|${position}|${data.date}\n`;
                    }
                    mwContent += `\n`;
                }
            });
            
            return mwContent;
        }
        function exportZPL() {
            if (labelQueue.length === 0) {
                showStatus('No labels in queue to export', 'error');
                return;
            }
            
            const template = document.getElementById('labelTemplate').value;
            const includeQR = document.getElementById('includeQR').checked;
            const includeDate = document.getElementById('includeDate').checked;
            const includePosition = document.getElementById('includePosition').checked;
            
            let zplContent = '';
            
            labelQueue.forEach(position => {
                const data = freezerData[position];
                if (data) {
                    zplContent += generateZPL(data, position, template, includeQR, includeDate, includePosition);
                }
            });
            
            const blob = new Blob([zplContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tube_labels_${new Date().toISOString().split('T')[0]}.zpl`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus(`Exported ${labelQueue.length} ZPL label commands`, 'success');
        }
        
        // Generate ZPL code for a single label
        function generateZPL(data, position, template, includeQR, includeDate, includePosition) {
            let zpl = '^XA\n'; // Start of label
            
            // Set label size (adjust based on actual label dimensions)
            zpl += '^LL0120\n'; // Label length
            zpl += '^PW400\n';  // Print width
            
            // Project name (largest text)
            zpl += '^FO20,20^A0N,25,25^FD' + data.project + '^FS\n';
            
            // Cell type and position
            let line2 = data.type;
            if (includePosition) {
                line2 += ' - ' + position;
            }
            zpl += '^FO20,50^A0N,15,15^FD' + line2 + '^FS\n';
            
            // Clone name (if present)
            if (data.clone) {
                zpl += '^FO20,70^A0N,15,15^FD' + data.clone + '^FS\n';
            }
            
            // Date (if included)
            if (includeDate) {
                const yPos = data.clone ? 90 : 70;
                zpl += '^FO20,' + yPos + '^A0N,12,12^FD' + data.date + '^FS\n';
            }
            
            // QR Code (if included)
            if (includeQR) {
                const qrData = data.project + '|' + position + '|' + data.date;
                zpl += '^FO300,20^BQN,2,4^FDMM,' + qrData + '^FS\n';
            }
            
            zpl += '^XZ\n'; // End of label
            
            return zpl;
        }
        
        // Print to Brady BBP12 (requires Brady Workstation software)
        function printToBrady() {
            if (labelQueue.length === 0) {
                showStatus('No labels in queue to print', 'error');
                return;
            }
            
            // Generate print data
            const printData = {
                labels: labelQueue.map(position => {
                    const data = freezerData[position];
                    return {
                        position: position,
                        project: data.project,
                        type: data.type,
                        clone: data.clone || '',
                        date: data.date,
                        qrData: `${data.project}|${position}|${data.date}`
                    };
                }),
                settings: {
                    template: document.getElementById('labelTemplate').value,
                    size: document.getElementById('labelSize').value,
                    includeQR: document.getElementById('includeQR').checked,
                    includeDate: document.getElementById('includeDate').checked,
                    includePosition: document.getElementById('includePosition').checked
                }
            };
            
            // Create a JSON file for Brady Workstation import
            const blob = new Blob([JSON.stringify(printData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `brady_print_job_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus(`Generated Brady print job for ${labelQueue.length} labels. Import the downloaded file into Brady Workstation.`, 'success');
            
            // Show instructions
            alert(`Print Job Created!\n\nTo print these labels:\n1. Open Brady Workstation software\n2. Import the downloaded JSON file\n3. Configure your BBP12 printer\n4. Select appropriate label stock\n5. Print the job\n\nTotal labels: ${labelQueue.length}`);
        }
        
        // Set today's date as default
        document.getElementById('freezeDate').valueAsDate = new Date();
        
        // Initialize the freezer box on page load
        initializeFreezerBox();
    </script>
</body>
</html>
